// api/chat.js - För Railway/Vercel/Netlify backend

// DIN KUNSKAPSTEXT - Ändra detta till dina enkätsvar
const KNOWLEDGE_BASE = `
Svar enkät 

______________________________________________________________________

Nämndsekreterare

För att få ut så mycket som möjligt av samordningen tror jag en förutsättning är att alla utgår från en gemensam arbetsplats. Det kommer dock finnas ett fortsatt behov av att kunna arbeta viss tid på den aktuella förvaltningen. Jag tror också att det är väldigt viktigt att det skapas en tydlig beskrivning av vad som ska ingå i uppdraget som nämndsekreterare.

Jag ser att en samordning ger möjlighet att renodla tjänsterna och att man får möjlighet att specialisera sig inom specifika områden. Samordningen kan också bidra till en minskad sårbarhet samt ökad möjlighet att förvaltningarna kan ha lika eller liknande nämndprocesser och andra arbetssätt. Samordningen bör också innebära att det blir enklare att dela med sig av kunskaper kring det gemensamma arbetsområdet. Det blir också enklare att ställa frågor och diskutera dagsaktuella frågor.

En utmaning blir att nämndsekreterna hamnar längre ifrån förvaltningscheferna. Detta är troligtvis utmanande både för förvaltningschef och nämndsekreterare. Det kan också vara utmanande att göra översyn av gemensamma processer och att försöka hitta gemensamma förhållningssätt. Vid en renodling och samordning av tjänster finns också en risk att vissa arbetsuppgifter som gjorts av nämndsekreterare, inte kan eller bör hanteras av just nämndsekreteraren längre. Det kan bli utmanande att hitta andra lösningar för dessa arbetsuppgifter.
______________________________________________________________________

Det finns många möjligheter med denna samordning. Vi kommer förmodligen att ha mer möten och avstämningar ihop, eventuellt sitta i samma byggnad. Detta kan leda till bättre resursanvändning och snabbare implementering av nya initiativ. Dessutom kan det främja en kultur av samarbete och innovation inom kommunen.

En av de största utmaningarna kan vara att få alla att anpassa sig till de nya strukturerna och arbetssätten. Det är också viktigt att säkerställa att ingen känner sig överbelastad, särskilt de som har flera roller.
______________________________________________________________________

Nämndsekreterare/registrator: Enhetligt arbetssätt, bättre kunna vara backup för varandra. Renodla rollen, som egentligen inte hör ihop med kvalitet/verksamhetsutveckling.

Kvalitet: En central organisation möjliggör tydligare styrsignaler, gemensamma arbetssätt och enhetliga rutiner. Det skapar förutsägbarhet och minskar risken för dubbelarbete eller motstridiga arbetssätt mellan förvaltningarna. Idag är det upp till resp FC hur och i vilken omfattning verksamhetsutveckling bedrivs och även upp till den person som innehar rollen. Kommunen behöver en övergripande verksamhetsutveckling, vilket centralisering kommer ge.

Nackdelar: När beslutsfattande och servicefunktioner flyttas längre bort från den lokala förvaltningen, kan det påverka tillgänglighet, förståelse för ʺlokalaʺ behov. Man mister känslan för ʺsinʺ förvaltning och kompetensen som man har om ʺsinʺ förvaltning.

Förvaltningarna har idag stora problem med avdelningen kommunikation som centraliserades för ett par år sedan. Man upplever inte att de arbetar som en stödfunktion till förvaltningarna längre utan mer åt KLK. Det är ofta ett ʺmission impossibleʺ att få hjälp från kommunikation vilket hindrar utvecklingen på förvaltningen. Från förvaltningarnas sida upplever man därför också att man har fått minskade resurser. Blir det likadant med centralisering av kvalitet så blir det absolut inte bra!

Allt det som dessa administrativa tjänsterna utför kommer heller inte kunna flytas med vilket ger förvaltningarna arbetsuppgifter som ska fördelas på kvarvarande personal och i flera fall finns det inte någon man kan överlämna till. De här tjänsterna har varit lite ʺspindeln i nätetʺ på mycket olika arbetsuppgifter som egentligen inte ryms i någon av de uttalade rollerna.

Sen tycker jag att även enhetschefer, verksamhetschefer och förvaltningschefer ska få ge sin syn på detta. Deras input är också viktig för att det här ska bli så bra som möjligt. Hoppas också att man på något sätt kan få ha kvar ʺsinʺ förvaltning och även kunna vara placerad på förvaltningen för att stötta och bevara kompetensen om verksamheterna.
______________________________________________________________________

Kvalitetsutvecklare/Digitalisering
Jag tänker att det finns ett par sätt att samordna detta, det ena är att man organiserar digitalisering/utveckling i en ny sektion under IT-chefen med tydligt uppdrag att det ska vara verksamhetsförlagd anknytning, och det andra sättet är att man inrättar en central enhet som har fokus på digitalisering/kvalitet men här finns det risk att man har två parallella organisationer som behöver nyttja varandras resurser och det ska stämma in i olika årshjul. Ska man samla kommunens resurser räcker det inte att man bara centraliserar funktionerna och tror det händer saker, vilket jag tycker det finns flera exempel internt hos oss i kommunen där det inte har gett någon effekt ute i verksamheterna.

Ska man få till samordning som ger effekt ska det vara tydligt att man i en samordnad verksamhet ska vara ute i verksamheten/förvaltningarna för det är genom ett nära band som man kan snappa upp behov/se utveckling som man sedan kan ta med tillbaka och samordna utveckling, tillsätta resurser och dra lärdom. Det är viktigt att det finns resurser för att arbeta med effektivisering, utveckling och implementering.

Att ta med under hösten är att det finns en hel del drift- och utvecklingsansvar för digitala system ute i förvaltningarna. Ska det följa med till den nya samordnande verksamheten eller ska förvaltningarna lösa det med nya tjänster?
______________________________________________________________________

Hela tiden skriver ni nämndsekreterare. Min titel är förvaltningssekreterare och jag stöttar förvaltningen dagligen i allehanda uppdrag, vilket jag kan göra då jag sitter ute på förvaltningen. Min roll som sekreterare i nämnden är en del av mitt uppdrag men inte allt. Farhågorna som både jag och mina kollegor i förvaltningen delar är att jag som sekreterare kommer att komma för långt från verksamheten när man gör den här centraliseringen och kanske även flyttar mig till KLK, samt att jag inte kommer att ha den tiden att hjälpa och stötta förvaltningen. Man missar dessutom mycket om man inte sitter nära verksamheten och även förvaltningschefen som jag också arbetar tätt inpå.
______________________________________________________________________

Min bild av centraliseringen är någon form av central enhet för uppföljning/utveckling/digitalisering. Där enheten är uppdelad i två delar, den ena delen som är fokuserad på uppföljning och den andra delen som är fokuserad på utveckling.

Uppföljningsdelen - Planering, uppföljning och analys
Dessa medarbetare jobbar med att följa upp och analysera kommunens verksamheter utifrån den politiska målsättningen (styrmodell och MoB process). Fokus för dessa personer är att genom uppföljning och analys identifiera avvikelser och utvecklingsmöjligheter. Dessa medarbetare lyfter utvecklingsmöjligheterna med ansvarig chef och utvecklare/digitalisering.

Utvecklingsdelen - Utveckling, innovation, digitalisering och automatisering
Till skillnad från uppföljningsdelen jobbar dessa medarbetare istället med utveckling och digitalisering. De avvikelser och utvecklingsmöjligheter som uppföljningsdelen identifierar tar utveckling över och hittar lösningar för tillsammans med ansvarig chef för området.

Med denna typ av uppdelning tror jag man kan få bra snurr på ett systematiskt kvalitetsarbete som faktiskt gör skillnad och som dessutom går i linje med den politiska viljeriktningen. Samtidigt är det viktigt att ha i åtanke att varje chef är ansvarig för sitt verksamhetsområde så att vi agerar som ett stöd snarare än någon som bestämmer.

Utmaningarna jag kan se är väl att kunna få driftfrågorna att rulla på, främst inom digitalisering, men vissa av dom frågorna kanske bättre förvaltas av IT? En annan utmaning jag ser är att samtliga nämnders styrmodell/mob processer fortfarande ska löpa på men med mindre folk. Men troligtvis ska det gå att lösa genom lite ansvarsuppdelning.
______________________________________________________________________

Kan bara konstatera att våra ledande politikerna i vår kommun inte har lever efter den vision och de mål som de själva beslutat om, såsom en god arbetsgivare, ett tillitsbaserat arbetssätt, öppenhet och transparens. Tyvärr saknas även kunskap inom förändringsarbete. Jag har mycket svårt att se att något skulle kunna bli bättre än det är idag. Med minskade resurser 2, 1 mnkr är risken däremot mycket stor att det blir sämre, både avseende stöd till förvaltningarna och för tjänstepersonernas arbetsmiljö. Utveckla och använd den tid som finns avsatt för de forum som finns idag, istället för att omorganisera.
Om det i någon förvaltning inte fungerar optimalt, åtgärda det men gör det inte på bekostnad av väl fungerade förvaltningar.
______________________________________________________________________

Jag ser utmaningar i att det eventuellt medför att man kommer långt bort från den verksamhet/förvaltning man jobbar för. Det brukar innebära att man får sämre insyn och förlorar helhetssynen på olika frågor som pågår vilket i sin tur påverkar kvaliten på det arbete man utför. Hur undviker vi detta?
______________________________________________________________________

En utmaning som jag ser med en samordning är att det är en fördel att vara nära förvaltningen. Kvalitetsutveckling och vilka behov som finns är inte lika på de olika förvaltningarna och jag tror att det är enklare att få förståelse för verksamheten och dess behov om man befinner sig i dess omedelbara närhet. När det gäller kvalitetsarbete behöver man ju ofta också ha med sig verksamheten i ʺtänketʺ vilket kanske blir svårare om man befinner sig - i alla fall delvis - utanför.

Utifrån ovanstående ser jag att det är bäst att den fysiska placeringen är på den förvaltning man arbetar emot. Samtidigt är det då problematiskt att man är fysiskt placerad på ett ställe men tillhör en annan organisation och har en chef på ett annat ställe. Någon form av delad fysisk placering kanske i så fall blir nödvändigt, men jag är tveksam till att det blir en effektivisering.

Jag jobbar både med kvalitetsutveckling och nämndadministration och jag tror att ovanstående gäller för båda delarna, men problematiken kanske är något mindre när det gäller nämndadministrationen då nämndprocessen mer eller mindre är lika oavsett förvaltning.

Den fördel jag kan se är att vi som jobbar med samma sak får närmare till varandra och att vi då på ett bättre sätt kan dra nytta av varandras kunskaper.
______________________________________________________________________

Utifrån min roll som digitaliseringsledare så ser jag att vi kommer längre ifrån vår verksamhet utifrån denna omorganisation. Det blir svårt med lätt och snabb kommunikation/beslut om vi inte får sitta tillsammans med den organisation vi arbetar för. Fördelar är att vi kan hjälpas åt och delge varandra kunskap. I och med tjänster ska dras in, vem ska göra deras arbete?
______________________________________________________________________

Samordning kan bestå i att vi kan ha regelbundna möten med andra förvaltningarnas digitaliseringsledare, kvalitetsledare och nämndsekreterarare, där vi delar våra kunskaper och erfarenheter. Förstår inte alls syftet då jag redan har en fulltecknad tjänst, där jag ser att effektivitet (utveckling, förvaltning) för socialförvaltningens verksamhet är hög. Det finns också ett förvaltningsövergripande digitaliseringsråd som ses kontinuerligt och diskuterar föreslagna digitala utvecklingar. Mycket viktigt, då arbete innebär att följa nämndens mål, verksamhetsutveckling och förvaltning, att vara nära verksamhet. Behöver fysiskt vara nära socialförvaltningens förvaltningschef, verksamhetschefer, enhetschefer, och systemförvaltare (IT-specialister) vilket gör att det inte är lämpligt att vara placerad centralt. Behöver vara fysiskt placerad med dem, som man arbetar tillsammans med, och den förvaltning som har massor av behov för att förbättra för både brukare, patienter och personalen. Min tjänst har en tydlig uppdragsbeskrivning, vilket jag trivs med att arbeta efter. Jag hoppas och tror att alla andra förvaltningarna har sådana för ovanstående roller.
Kan inte ta på mig fler uppgifter än de som redan finns. Socialförvaltningen har många system att utveckla och förvalta, samt att vi hela tiden tar in nytt efter behov från verksamhet och avvecklar ʺgammaltʺ. Som systemvetare, ser jag jag att socialförvaltningens organisation är uppsatt metodiskt och robust. Vi arbetar med ʺkänsligaʺ områden som kommunal hälso- och sjukvård och barn och unga. Vill gärna vara kvar, brinna och lägga massor av energi för arbete inom dessa områden som ligger mig varmt om hjärtat och är så viktiga.

______________________________________________________________________

Det är också viktigt att vi inom socialförvaltningen stab får kvarstå på samordningsmöten och APT med de kollegor i stab vi har, för att tillsammans med dem utveckla soc. system och processer på ett för verksamheten och dess brukare bästa sätt. Behöver t.ex nära samröre/samarbete med MAS, SAS, MAR. Om vi inte är med missar vi även specifik information om vad som händer inom socialförvaltningen, t.ex. vad gäller processförändringar (både inom och utanför verksamhet), lagstiftningsförändringar, nationella/regionala överenskommelser mm. Det skulle försvåra och bli merarbete för oss, om detta inte skulle kunna kvarstå.
______________________________________________________________________

Jag skulle vilja veta vilka förbättringar och effektiviseringar man hoppas ska ske iom denna förändring. Jag tycker inte att det framgår.

Det står nämndsekreterare - jag är anställd som förvaltningssekreterare vilket inte riktigt är samma typ av tjänst. Skillnader: En förvaltningssekreterare arbetar mer generellt inom en förvaltnings administrativa stöd och har ett bredare uppdrag, medan en nämndsekreterare är mer fokuserad på det administrativa stödet till en specifik nämnd och dess politiker.
Som förvaltningssekreterare så ser jag ett behov av att finnas nära förvaltningen som ett stöd. Om tanken är att vi fortsättningsvis ska vara just ett stöd till förvaltningen så ser jag inte vitsen med att sitta centralt. Om det däremot finns en annan tanke på sikt att stödet inte ska vara främst mot förvaltningen – så kan jag förstå vitsen med att placeras centralt.
Jag kan se både fördelar och nackdelar med en omorganisation i detta läge- jag tar med dessa tankar till workshopen.

`;

// Hämta API-nyckel från miljövariabel (säkert!)
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

// Huvudfunktion som hanterar chat-förfrågningar
export default async function handler(req, res) {
  // Hantera CORS (Cross-Origin Resource Sharing)
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  // Hantera preflight-förfrågningar
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  // Endast POST-förfrågningar tillåtna
  if (req.method !== 'POST') {
    return res.status(405).json({ 
      error: 'Endast POST-förfrågningar tillåtna' 
    });
  }

  try {
    // Hämta meddelandet från användaren
    const { message } = req.body;

    // Validera inkommande data
    if (!message || typeof message !== 'string' || message.trim().length === 0) {
      return res.status(400).json({ 
        error: 'Meddelande krävs och får inte vara tomt' 
      });
    }

    // Kontrollera att meddelandet inte är för långt
    if (message.length > 1000) {
      return res.status(400).json({ 
        error: 'Meddelandet är för långt (max 1000 tecken)' 
      });
    }

    // Skapa system-prompt för AI:n
    const systemPrompt = `Du är en hjälpsam assistent som analyserar enkätsvar om samordning. Du ska endast svara baserat på den information som finns i enkätsvaren nedan. 

INSTRUKTIONER:
- Svara alltid på svenska
- Basera dina svar endast på informationen i enkätsvaren
- Om frågan inte kan besvaras utifrån enkätsvaren, säg det tydligt
- Var konkret och hänvisa till vad respondenterna faktiskt sagt
- Du kan sammanfatta och analysera informationen, men hitta inte på ny information

ENKÄTSVAR:
${KNOWLEDGE_BASE}

Besvara användarens fråga baserat enbart på ovanstående enkätsvar.`;

    // Anropa OpenAI API
    const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: [
          {
            role: 'system',
            content: systemPrompt
          },
          {
            role: 'user',
            content: message.trim()
          }
        ],
        max_tokens: 500,
        temperature: 0.7,
        presence_penalty: 0.1,
        frequency_penalty: 0.1
      })
    });

    // Kontrollera om OpenAI-anropet lyckades
    if (!openaiResponse.ok) {
      console.error('OpenAI API fel:', openaiResponse.status, openaiResponse.statusText);
      
      if (openaiResponse.status === 401) {
        return res.status(500).json({ 
          error: 'API-konfigurationsfel. Kontakta administratören.' 
        });
      }
      
      return res.status(500).json({ 
        error: 'AI-tjänsten är tillfälligt otillgänglig. Försök igen om en stund.' 
      });
    }

    const aiData = await openaiResponse.json();

    // Kontrollera att vi fick ett svar från AI:n
    if (!aiData.choices || !aiData.choices[0] || !aiData.choices[0].message) {
      return res.status(500).json({ 
        error: 'Oväntat svar från AI-tjänsten' 
      });
    }

    const aiResponse = aiData.choices[0].message.content;

    // Logga för debugging (ta bort i produktion om du vill)
    console.log('Användare frågade:', message);
    console.log('AI svarade:', aiResponse);

    // Skicka tillbaka svaret
    res.status(200).json({ 
      response: aiResponse,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    // Logga fel för debugging
    console.error('Serverfel i chat.js:', error);

    // Skicka generiskt felmeddelande till användaren
    res.status(500).json({ 
      error: 'Ett oväntat fel uppstod. Försök igen om en stund.' 
    });
  }
}

// Alternativ export för olika plattformar
module.exports = handler;
